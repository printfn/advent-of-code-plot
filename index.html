<html>
<head>

<title>Advent of Code Leaderboard Plot</title>

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.min.js"></script>
<script>

let backgroundColors = [
    'rgba(255, 99, 132, 0.2)',
    'rgba(54, 162, 235, 0.2)',
    'rgba(255, 206, 86, 0.2)',
    'rgba(75, 192, 192, 0.2)',
    'rgba(153, 102, 255, 0.2)',
    'rgba(255, 159, 64, 0.2)'
];

let borderColors = [
    'rgba(255, 99, 132, 1)',
    'rgba(54, 162, 235, 1)',
    'rgba(255, 206, 86, 1)',
    'rgba(75, 192, 192, 1)',
    'rgba(153, 102, 255, 1)',
    'rgba(255, 159, 64, 1)'
];

function updateGraph() {
    try {
        let leaderboardData = JSON.parse(document.getElementById('json').value);
        console.log(leaderboardData);

        let year = parseInt(leaderboardData.event);
        let startTimestamp = 0;
        for (let y = 1970; y <= year; ++y) {
            let isLeap = y % 400 == 0 ? true : y % 100 == 0 ? false : y % 4 == 0;
            console.log(y, isLeap);
            startTimestamp += 86400 * (isLeap ? 366 : 365);
        }
        startTimestamp -= 86400 * 32;
        startTimestamp += 3600 * 5;
        console.log('startTimestamp', startTimestamp);
        console.log('now', 1608876296);

        const timeDivisor = 60/100;
        const showRealData = true;

        let chartData = {
            type: 'bar',
            data: {
                labels: ['Red', 'Blue', 'Yellow', 'Green', 'Purple', 'Orange'],
                datasets: [{
                    label: 'Minutes Since Start',
                    data: [12, 19, 3, 5, 2, 3],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1,
                    stack: 'first'
                }, {
                    label: 'Minutes Since Start',
                    data: [22, 19, 3, 5, 2, 3],
                    backgroundColor: [
                        'rgba(255, 99, 132, 0.2)',
                        'rgba(54, 162, 235, 0.2)',
                        'rgba(255, 206, 86, 0.2)',
                        'rgba(75, 192, 192, 0.2)',
                        'rgba(153, 102, 255, 0.2)',
                        'rgba(255, 159, 64, 0.2)'
                    ],
                    borderColor: [
                        'rgba(255, 99, 132, 1)',
                        'rgba(54, 162, 235, 1)',
                        'rgba(255, 206, 86, 1)',
                        'rgba(75, 192, 192, 1)',
                        'rgba(153, 102, 255, 1)',
                        'rgba(255, 159, 64, 1)'
                    ],
                    borderWidth: 1,
                    stack: 'second'
                }]
            },
            options: {
                scales: {
                    xAxes: [{
                        stacked: true
                    }],
                    yAxes: [{
                        ticks: {
                            //stepSize: 1,
                            //beginAtZero: true
                            callback: function(value, index, values) {
                                if (value.toString().startsWith('5')) return null;
                                if (value.toString().startsWith('7')) return null;
                                if (value.toString().startsWith('8')) return null;
                                if (value.toString().startsWith('9')) return null;

                                let seconds = Math.floor(parseFloat(value) * timeDivisor);
                                let minutes = Math.floor(seconds / 60);
                                seconds %= 60;
                                let hours = Math.floor(minutes / 60);
                                minutes %= 60;
                                let days = Math.floor(hours / 24);
                                hours %= 24;

                                let str = '';

                                if (days > 0) {
                                    str += days + ' day(s), ';
                                }
                                if (hours > 0) {
                                    str += hours.toString().padStart(2, '0') + ':';
                                }
                                str += minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');

                                return str;
                            }
                        },
                        stacked: true,
                        type: 'logarithmic',
                        scaleLabel: {
                            display: true,
                            labelString: 'Duration',
                        }
                    }],
                },
                tooltips: {
                    callbacks: {
                        label: function(tooltipItem, data) {
                            var label = data.datasets[tooltipItem.datasetIndex].label || '';

                            if (label) {
                                label += ': ';
                            }

                            let seconds = Math.floor(parseFloat(tooltipItem.yLabel));
                            let minutes = Math.floor(seconds / 60);
                            seconds %= 60;
                            let hours = Math.floor(minutes / 60);
                            minutes %= 60;
                            let days = Math.floor(hours / 24);
                            hours %= 24;

                            let duration = '';
                            if (days > 0) {
                                duration += days + ' day(s), ';
                            }
                            if (hours > 0) {
                                duration += hours.toString().padStart(2, '0') + ':';
                            }
                            // if (minutes > 0) {
                            //     duration += minutes + ':';
                            // }
                            duration += minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0')

                            label += duration;
                            return label;
                        }
                    }
                }
            }
        };

        if (showRealData) {
            chartData.data.datasets = [];
            chartData.data.labels = [];

            let i = 0;
            for (let memberId in leaderboardData.members) {
                let member = leaderboardData.members[memberId];
                let dataset = {
                    label: member.name,
                    data: [],
                    backgroundColor: [],
                    borderColor: [],
                    borderWidth: 1,
                    stack: member.name,
                    minBarLength: 2
                };
                for (let day = 1; day <= 31; ++day) {
                    for (let part of [1, 2]) {
                        if (member.completion_day_level[day] && member.completion_day_level[day][part]) {
                            let ts = member.completion_day_level[day][part].get_star_ts;
                            let durationInSeconds = ts - startTimestamp - 86400 * parseInt(day);
                            dataset.data.push(durationInSeconds / timeDivisor);
                        } else {
                            dataset.data.push(null);
                        }
                        dataset.backgroundColor.push(backgroundColors[i]);
                        dataset.borderColor.push(borderColors[i]);
                        if (i == 0) {
                            chartData.data.labels.push(`Day ${day} Part ${part}`);
                        }
                    }
                }
                chartData.data.datasets.push(dataset);
                console.log(member.name)
                ++i;
            }
        }

        let ctx = document.getElementById('chart');
        let myChart = new Chart(ctx, chartData);

        document.getElementById('errors').innerText = "";
    } catch (err) {
        document.getElementById('errors').innerText = err;
    }
}

window.onload = () => {
    document.getElementById('json').addEventListener('change', updateGraph);
    document.getElementById('json').addEventListener('keyup', updateGraph);
    document.getElementById('json').addEventListener('paste', updateGraph);
    updateGraph();
}

</script>

<style>
#wrap {
    max-width: 1280px;
    background-color: #f3f3f3;
    margin: auto;
    padding: 10px;
}
body {
    background-color: #f7f7f7;
}
textarea {
    width: 100%;
}
</style>

</head>
<body>

<div id="wrap">
    <textarea id="json">{"event":"2020","members":{"22105":{"local_score":142,"name":"printfn","last_star_ts":"1608873180","stars":50,"id":"22105","completion_day_level":{"15":{"1":{"get_star_ts":"1608009169"},"2":{"get_star_ts":"1608010763"}},"25":{"2":{"get_star_ts":"1608873180"},"1":{"get_star_ts":"1608873169"}},"24":{"1":{"get_star_ts":"1608861205"},"2":{"get_star_ts":"1608861747"}},"6":{"1":{"get_star_ts":"1607231287"},"2":{"get_star_ts":"1607231562"}},"13":{"2":{"get_star_ts":"1607837445"},"1":{"get_star_ts":"1607836055"}},"22":{"2":{"get_star_ts":"1608614668"},"1":{"get_star_ts":"1608613508"}},"17":{"2":{"get_star_ts":"1608184324"},"1":{"get_star_ts":"1608183533"}},"12":{"1":{"get_star_ts":"1607755740"},"2":{"get_star_ts":"1607756348"}},"21":{"1":{"get_star_ts":"1608533890"},"2":{"get_star_ts":"1608534373"}},"11":{"2":{"get_star_ts":"1607671025"},"1":{"get_star_ts":"1607670211"}},"2":{"1":{"get_star_ts":"1606885392"},"2":{"get_star_ts":"1606885508"}},"5":{"1":{"get_star_ts":"1607148767"},"2":{"get_star_ts":"1607149021"}},"18":{"1":{"get_star_ts":"1608282736"},"2":{"get_star_ts":"1608283970"}},"1":{"2":{"get_star_ts":"1606805157"},"1":{"get_star_ts":"1606805081"}},"16":{"2":{"get_star_ts":"1608097299"},"1":{"get_star_ts":"1608095281"}},"19":{"1":{"get_star_ts":"1608360572"},"2":{"get_star_ts":"1608365456"}},"20":{"2":{"get_star_ts":"1608446246"},"1":{"get_star_ts":"1608444729"}},"7":{"1":{"get_star_ts":"1607317927"},"2":{"get_star_ts":"1607318873"}},"4":{"1":{"get_star_ts":"1607065548"},"2":{"get_star_ts":"1607066426"}},"14":{"1":{"get_star_ts":"1607922723"},"2":{"get_star_ts":"1607923196"}},"23":{"2":{"get_star_ts":"1608702846"},"1":{"get_star_ts":"1608700564"}},"3":{"2":{"get_star_ts":"1606985637"},"1":{"get_star_ts":"1606985401"}},"10":{"2":{"get_star_ts":"1607578636"},"1":{"get_star_ts":"1607576918"}},"9":{"1":{"get_star_ts":"1607495809"},"2":{"get_star_ts":"1607496144"}},"8":{"1":{"get_star_ts":"1607407596"},"2":{"get_star_ts":"1607407937"}}},"global_score":0},"420711":{"completion_day_level":{"7":{"1":{"get_star_ts":"1607323202"},"2":{"get_star_ts":"1607324110"}},"13":{"2":{"get_star_ts":"1607843597"},"1":{"get_star_ts":"1607839838"}},"4":{"2":{"get_star_ts":"1607085511"},"1":{"get_star_ts":"1607071090"}},"14":{"2":{"get_star_ts":"1607936872"},"1":{"get_star_ts":"1607933511"}},"6":{"2":{"get_star_ts":"1607231954"},"1":{"get_star_ts":"1607231855"}},"12":{"1":{"get_star_ts":"1607836873"},"2":{"get_star_ts":"1607837743"}},"3":{"2":{"get_star_ts":"1606988302"},"1":{"get_star_ts":"1606986986"}},"10":{"1":{"get_star_ts":"1607577723"},"2":{"get_star_ts":"1607583086"}},"11":{"2":{"get_star_ts":"1607674031"},"1":{"get_star_ts":"1607671711"}},"2":{"2":{"get_star_ts":"1606887453"},"1":{"get_star_ts":"1606887172"}},"1":{"2":{"get_star_ts":"1606817713"},"1":{"get_star_ts":"1606817175"}},"5":{"2":{"get_star_ts":"1607185713"},"1":{"get_star_ts":"1607184997"}},"9":{"1":{"get_star_ts":"1607574553"},"2":{"get_star_ts":"1607576481"}},"8":{"1":{"get_star_ts":"1607428072"},"2":{"get_star_ts":"1607431483"}}},"id":"420711","last_star_ts":"1607936872","stars":28,"local_score":50,"name":"Jamie","global_score":0},"225901":{"global_score":0,"completion_day_level":{"4":{"2":{"get_star_ts":"1607230299"},"1":{"get_star_ts":"1607219099"}},"6":{"1":{"get_star_ts":"1607231047"},"2":{"get_star_ts":"1607231247"}},"7":{"1":{"get_star_ts":"1608882459"},"2":{"get_star_ts":"1608882788"}},"8":{"2":{"get_star_ts":"1608889870"},"1":{"get_star_ts":"1608883981"}},"5":{"1":{"get_star_ts":"1607229175"},"2":{"get_star_ts":"1607229941"}},"1":{"2":{"get_star_ts":"1606825183"},"1":{"get_star_ts":"1606825135"}},"2":{"1":{"get_star_ts":"1607217004"},"2":{"get_star_ts":"1607217254"}},"3":{"1":{"get_star_ts":"1607218043"},"2":{"get_star_ts":"1607218453"}}},"stars":16,"last_star_ts":"1608889870","id":"225901","name":"Rhys Davies","local_score":18}},"owner_id":"225901"}</textarea>
    <p id="errors"></p>
    <div class="chart-container" style="position: relative">
        <canvas id="chart"></canvas>
    </div>
</div>

</body>
</html>
